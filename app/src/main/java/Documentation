Alright âœ… â€” hereâ€™s a clear **visual diagram** of your appâ€™s workflow showing how each class interacts in both the **manual** and **automatic backup flows**.

***

## ðŸ“Œ **Architecture & Data Flow Diagram**

```plaintext
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        User Interaction
 â”‚ MainActivity     â”‚
 â”‚----------------- â”‚       -------------------------
 â”‚ - btnAvailable   â”‚------> Show Detected Devices
 â”‚ - btnBackup      â”‚------> Trigger Manual Backup
 â”‚ - txtResult      â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ UI Callback
         â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ NetworkMonitor   â”‚
 â”‚----------------- â”‚
 â”‚ Detect Wi-Fi /   â”‚
 â”‚ Hotspot state    â”‚
 â”‚ Detect Subnet    â”‚
 â”‚ Scan Subnet IPs  â”‚
 â”‚ ARP Table -> MAC â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ List
         â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ DeviceManager          â”‚
 â”‚------------------------â”‚
 â”‚ Load Whitelisted MACs  â”‚
 â”‚ Filter Devices         â”‚
 â”‚ Add to Whitelist       â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ Whitelisted Device(s)
          â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  One Match? â”‚â”€â”€â”€â”€ YES â”€â”€â”€â”€â”€â”€â”€â–º Proceed to Backup
     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
            â”‚NO
            â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ User Chooses from List   â”‚
 â”‚ [Optional: Whitelist]    â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ Selected Device
            â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ FileBackupManager       â”‚
 â”‚-------------------------â”‚
 â”‚ Get Files to Backup     â”‚
 â”‚ Retry Failed Uploads    â”‚
 â”‚ Calls SmbjClient         â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ For each file
            â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ SmbjClient (SMB2/3)     â”‚
 â”‚-------------------------â”‚
 â”‚ Connect to PC SMB Share â”‚
 â”‚ Authenticate            â”‚
 â”‚ Overwrite/Write File    â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

***

## **Flow Breakdown**

### **1. Automatic Backup (Background)**
- `BackupService` wakes up every **30 min** (configurable)
- It calls `NetworkMonitor`:
  - If **Wi-Fi** or **Hotspot** is ON â†’ scan subnet.
  - Gets list of `(IP, MAC)` pairs.
- `DeviceManager`:
  - Filters against whitelist.
  - If **1 device** â†’ backup immediately.
  - If **0 or >1** devices â†’ calls `deviceSelectionCallback` (only works if UI is active).
- Runs `FileBackupManager` for the target device.

***

### **2. Manual Backup (User Trigger from MainActivity)**
- User presses `btnBackup`.
- MainActivity:
  - Calls `NetworkMonitor.scanSubnetAsync()`.
  - Uses `DeviceManager` to filter.
  - If 1 match â†’ proceed straight to backup.
  - Else â†’ show dialog of `DeviceInfo` for the user to pick â†’ store in whitelist (optional).
- `FileBackupManager` runs with the chosen deviceâ€™s IP.

***

### **3. Device Detection Logic**
- Uses **dynamic subnet detection** from current Wi-Fi/Hotspot IP.
- Pings all IPs in that subnet (`*.2` to `*.254`).
- Reads Androidâ€™s `/proc/net/arp` file for MAC mapping.
- Filters devices whose MAC is in whitelist.

***

### **4. Backup Execution**
- `FileBackupManager` selects files & retries uploads (up to 3 times).
- `SmbjClient` connects to SMB share:
  - Auth with configured **username/password**.
  - Writes file (overwrite if exists).

***

## ðŸ”¹ **Advantages of Current Design**
- Works for **Wi-Fi** and **Hotspot** scenarios.
- Avoids accidental backup to unknown devices (MAC whitelist).
- User can **add MAC to whitelist** after discovery.
- Supports both **manual** and **scheduled** backups.
- Uses **dynamic subnet detection** instead of hardcoding IP range.
- Handles SMB file uploads with retries.

***

## ðŸ”¹ **Potential Future Enhancements**
- Show progress bar during scanning/backups in UI.
- Store last backup time per file and skip unchanged (already partly supported).
- Better handling when **UI is not active** but user interaction is required for multiple connected devices.
- A notification to show backup success/failure from background service.

***
